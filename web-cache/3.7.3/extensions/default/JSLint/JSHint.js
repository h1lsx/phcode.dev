define(function(require,exports,module){const _=brackets.getModule("thirdparty/lodash"),CodeInspection=brackets.getModule("language/CodeInspection"),FileSystemError=brackets.getModule("filesystem/FileSystemError"),AppInit=brackets.getModule("utils/AppInit"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),DocumentManager=brackets.getModule("document/DocumentManager"),Strings=brackets.getModule("strings"),ProjectManager=brackets.getModule("project/ProjectManager"),FileSystem=brackets.getModule("filesystem/FileSystem"),IndexingWorker=brackets.getModule("worker/IndexingWorker");Phoenix.isTestWindow&&IndexingWorker.on("JsHint_extension_Loaded",()=>{window._JsHintExtensionReadyToIntegTest=!0}),IndexingWorker.loadScriptInWorker(`${module.uri}/../worker/jslint-helper.js`);let prefs=PreferencesManager.getExtensionPrefs("jshint"),projectSpecificOptions=null,jsHintConfigFileErrorMessage=null;const PREFS_JSHINT_DISABLED="disabled";let DEFAULT_OPTIONS={esversion:11,browser:!0,node:!0,jquery:!0,rhino:!1,jasmine:!0,devel:!1};function _getLinterConfigFileErrorMsg(){return[{pos:{line:-1,ch:0},message:jsHintConfigFileErrorMessage,type:CodeInspection.Type.ERROR}]}async function lintOneFile(text,_fullPath){return new Promise(resolve=>{if(jsHintConfigFileErrorMessage)return void resolve({errors:_getLinterConfigFileErrorMsg()});text=text.replace(/^[ \t]+$/gm,"");let options=projectSpecificOptions||DEFAULT_OPTIONS;IndexingWorker.execPeer("jsHint",{text:text,options:options}).then(jsHintErrors=>{if(!jsHintErrors.lintResult&&jsHintErrors.errors.length){let errors=jsHintErrors.errors;errors=errors.map(function(lintError){return{pos:{line:lintError.line-1,ch:lintError.character},message:`${lintError.reason} jshint (${lintError.code})`,type:CodeInspection.Type.ERROR}}),resolve({errors:errors})}resolve()})})}prefs.definePreference("disabled","boolean",!1,{description:Strings.DESCRIPTION_JSHINT_DISABLE}).on("change",function(){CodeInspection.requestRun(Strings.JSHINT_NAME)});const CONFIG_FILE_NAME=".jshintrc";function removeComments(str){return str=(str=(str=str||"").replace(/\/\*(?:(?!\*\/)[\s\S])*\*\//g,"")).replace(/\/\/[^\n\r]*/g,"")}function _readConfig(dir,configFileName){return new Promise((resolve,reject)=>{configFileName=configFileName||CONFIG_FILE_NAME;const configFilePath=path.join(dir,configFileName);let displayPath=ProjectManager.makeProjectRelativeIfPossible(configFilePath);displayPath=Phoenix.app.getDisplayPath(displayPath),DocumentManager.getDocumentForPath(configFilePath).done(function(configDoc){let config;const content=configDoc.getText();try{config=JSON.parse(removeComments(content)),console.log("JSHint: loaded config file for project "+configFilePath)}catch(e){return console.log("JSHint: error parsing "+configFilePath),void reject("Error parsing JSHint config file:    "+displayPath)}if(config.extends){let extendFile=FileSystem.getFileForPath(path.join(dir,config.extends));_readConfig(extendFile.parentPath,extendFile.name).then(baseConfigResult=>{delete config.extends;let mergedConfig=$.extend({},baseConfigResult,config);config.globals&&delete config.globals,resolve(mergedConfig)}).catch(()=>{let extendDisplayPath=ProjectManager.makeProjectRelativeIfPossible(extendFile.fullPath);extendDisplayPath=Phoenix.app.getDisplayPath(extendDisplayPath),reject("Error parsing JSHint config file: "+extendDisplayPath)})}else resolve(config)}).fail(err=>{err!==FileSystemError.NOT_FOUND?(console.error("Error reading JSHint Config File",configFilePath,err),reject("Error reading JSHint Config File",displayPath)):resolve(null)})})}function _reloadOptions(){projectSpecificOptions=null,_readConfig(ProjectManager.getProjectRoot().fullPath,CONFIG_FILE_NAME).then(config=>{projectSpecificOptions=config,CodeInspection.requestRun(Strings.JSHINT_NAME),jsHintConfigFileErrorMessage=null}).catch(err=>{jsHintConfigFileErrorMessage=err,CodeInspection.requestRun(Strings.JSHINT_NAME)})}function isJSHintConfigActive(){return!(!jsHintConfigFileErrorMessage&&!projectSpecificOptions)}function _isFileInArray(fileToCheck,fileArray){if(!fileArray)return!1;for(let file of fileArray)if(file.fullPath===fileToCheck.fullPath)return!0;return!1}function _projectFileChanged(_evt,entry,added,removed){let configFilePath=FileSystem.getFileForPath(ProjectManager.getProjectRoot().fullPath+CONFIG_FILE_NAME);entry&&entry.fullPath===configFilePath.fullPath||_isFileInArray(configFilePath,added)?_reloadOptions():_isFileInArray(configFilePath,removed)&&(projectSpecificOptions=null,jsHintConfigFileErrorMessage=null)}AppInit.appReady(function(){ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanged),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_reloadOptions),_reloadOptions()}),CodeInspection.register("javascript",{name:Strings.JSHINT_NAME,scanFileAsync:lintOneFile,canInspect:function(fullPath){return!prefs.get("disabled")&&fullPath&&!fullPath.endsWith(".min.js")}}),exports.isJSHintConfigActive=isJSHintConfigActive});
//# sourceMappingURL=JSHint.js.map
