define(function(require,exports,module){const EventDispatcher=require("utils/EventDispatcher"),LiveDevProtocolRemote=require("text!LiveDevelopment/BrowserScripts/LiveDevProtocolRemote.js"),DocumentObserver=require("text!LiveDevelopment/BrowserScripts/DocumentObserver.js"),LanguageManager=require("language/LanguageManager"),RemoteFunctions=require("text!LiveDevelopment/BrowserScripts/RemoteFunctions.js"),EditorManager=require("editor/EditorManager"),LiveDevMultiBrowser=require("LiveDevelopment/LiveDevMultiBrowser"),PreferencesManager=require("preferences/PreferencesManager"),HTMLInstrumentation=require("LiveDevelopment/MultiBrowserImpl/language/HTMLInstrumentation"),StringUtils=require("utils/StringUtils"),FileViewController=require("project/FileViewController"),MainViewManager=require("view/MainViewManager"),LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME=`phoenix_live_preview_scripts_instrumented_${StringUtils.randomString(8)}.js`,LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME=`pageLoaderWorker_${StringUtils.randomString(8)}.js`,EVENT_LIVE_PREVIEW_CLICKED="livePreviewClicked",EVENT_LIVE_PREVIEW_RELOAD="livePreviewReload";var _connections={},_transport=null,_nextMsgId=1,_responseDeferreds={};function getConnectionIds(){return Object.keys(_connections)}function _focusEditorIfNeeded(editor,tagName,contentEditable){const focusShouldBeInLivePreview=["INPUT","TEXTAREA"].includes(tagName)||contentEditable;focusShouldBeInLivePreview||editor.focus()}const cssLangIDS=["css","scss","sass","less"],lessLangIDS=["scss","sass","less"];function _isLessOrSCSS(editor){if(!editor)return!1;const language=LanguageManager.getLanguageForPath(editor.document.file.fullPath);return language&&lessLangIDS.includes(language.getId())}function _searchAndCursorIfCSS(editor,allSelectors,nodeName){const codeMirror=editor._codeMirror,language=LanguageManager.getLanguageForPath(editor.document.file.fullPath);if(!language||!cssLangIDS.includes(language.getId()))return;if(allSelectors&&allSelectors.length)for(let selector of allSelectors){const cursor=codeMirror.getSearchCursor(selector),found=cursor.findNext();if(found)return void editor.setCursorPos(cursor.from().line,cursor.from().ch,!0)}const htmlTagSearch=new RegExp(nodeName,"i"),cursor=codeMirror.getSearchCursor(htmlTagSearch),found=cursor.findNext();found&&editor.setCursorPos(cursor.from().line,cursor.from().ch,!0)}function _tagSelectedInLivePreview(tagId,nodeName,contentEditable,allSelectors){const highlightPref=PreferencesManager.getViewState("livedevHighlight");if(!highlightPref)return;const liveDoc=LiveDevMultiBrowser.getCurrentLiveDoc(),activeEditor=EditorManager.getActiveEditor(),activeFullEditor=EditorManager.getCurrentFullEditor(),liveDocPath=liveDoc?liveDoc.doc.file.fullPath:null,activeEditorPath=activeEditor?activeEditor.document.file.fullPath:null,activeFullEditorPath=activeFullEditor?activeFullEditor.document.file.fullPath:null;if(!liveDocPath)return void(activeEditor&&activeEditor.focus());const openFullEditors=MainViewManager.findInOpenPane(liveDocPath),openLiveDocEditor=openFullEditors.length?openFullEditors[0].editor:null;function selectInHTMLEditor(fullHtmlEditor){const position=HTMLInstrumentation.getPositionFromTagId(fullHtmlEditor,parseInt(tagId,10));if(position&&fullHtmlEditor){const masterEditor=fullHtmlEditor.document._masterEditor||fullHtmlEditor;masterEditor.setCursorPos(position.line,position.ch,!0),_focusEditorIfNeeded(masterEditor,nodeName,contentEditable)}}if(liveDocPath===activeFullEditorPath)selectInHTMLEditor(activeFullEditor);else if(liveDoc.isRelated(activeEditorPath)||_isLessOrSCSS(activeEditor))activeEditor.focus(),_searchAndCursorIfCSS(activeEditor,allSelectors,nodeName);else if(openLiveDocEditor)selectInHTMLEditor(openLiveDocEditor);else{const foundInWorkingSetPane=MainViewManager.findInAllWorkingSets(liveDocPath),paneToUse=foundInWorkingSetPane.length?foundInWorkingSetPane[0].paneId:MainViewManager.ACTIVE_PANE,viewToUse=paneToUse===MainViewManager.ACTIVE_PANE?FileViewController.PROJECT_MANAGER:FileViewController.WORKING_SET_VIEW;FileViewController.openAndSelectDocument(liveDocPath,viewToUse,paneToUse).done(()=>{selectInHTMLEditor(EditorManager.getActiveEditor())})}}function _receive(clientId,msgStr){var msg=JSON.parse(msgStr),event=msg.method||"event",deferred;msg.id?(deferred=_responseDeferreds[msg.id])&&(delete _responseDeferreds[msg.id],msg.error?deferred.reject(msg):deferred.resolve(msg)):msg.clicked&&msg.tagId?(_tagSelectedInLivePreview(msg.tagId,msg.nodeName,msg.contentEditable,msg.allSelectors),exports.trigger(EVENT_LIVE_PREVIEW_CLICKED,msg)):(msg.clientId=clientId,exports.trigger(event,msg))}function _send(msg,clients){var id=_nextMsgId++,result=new $.Deferred;return clients=clients||getConnectionIds(),msg.id=id,_responseDeferreds[id]=result,_transport.send(clients,JSON.stringify(msg)),result.promise()}function _connect(clientId,url){_connections[clientId]=!0,exports.trigger("ConnectionConnect",{clientId:clientId,url:url})}function _close(clientId){_connections[clientId]&&(delete _connections[clientId],exports.trigger("ConnectionClose",{clientId:clientId}))}function setTransport(transport){_transport&&_transport.off(".livedev"),(_transport=transport).on("connect.livedev",function(event,msg){_connect(msg[0],msg[1])}).on("message.livedev",function(event,msg){_receive(msg[0],msg[1])}).on("close.livedev",function(event,msg){_close(msg[0])}),_transport.start()}function _getRemoteFunctionsScript(){let script="";return script+=DocumentObserver,"\n"+(script+="\nwindow._LD=("+RemoteFunctions+"("+JSON.stringify(LiveDevMultiBrowser.config)+"))")+"\n"}function getRemoteScriptContents(){const transportScript=_transport.getRemoteScript()||"",remoteFunctionsScript=_getRemoteFunctionsScript()||"";return transportScript+"\n"+LiveDevProtocolRemote+"\n"+remoteFunctionsScript}function getRemoteScript(){return`\n\t\t<script src="${LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME}"><\/script>`}function evaluate(script,clients){return _send({method:"Runtime.evaluate",params:{expression:script}},clients)}function setStylesheetText(url,text,clients){return _send({method:"CSS.setStylesheetText",params:{url:url,text:text}})}function getStylesheetText(url,clients){return _send({method:"CSS.getStylesheetText",params:{url:url}},clients)}function reload(ignoreCache,clients){return exports.trigger(EVENT_LIVE_PREVIEW_RELOAD,clients),_send({method:"Page.reload",params:{ignoreCache:!0}},clients)}function close(clientId){_transport.close(clientId)}function closeAllConnections(){getConnectionIds().forEach(function(clientId){close(clientId)}),_connections={}}EventDispatcher.makeEventDispatcher(exports),exports.setTransport=setTransport,exports.getRemoteScript=getRemoteScript,exports.getRemoteScriptContents=getRemoteScriptContents,exports.evaluate=evaluate,exports.setStylesheetText=setStylesheetText,exports.getStylesheetText=getStylesheetText,exports.reload=reload,exports.close=close,exports.getConnectionIds=getConnectionIds,exports.closeAllConnections=closeAllConnections,exports.LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME=LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME,exports.LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME=LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME,exports.EVENT_LIVE_PREVIEW_CLICKED=EVENT_LIVE_PREVIEW_CLICKED,exports.EVENT_LIVE_PREVIEW_RELOAD=EVENT_LIVE_PREVIEW_RELOAD});
//# sourceMappingURL=LiveDevProtocol.js.map
