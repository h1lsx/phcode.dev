define(function(require,exports,module){const ExtensionUtils=require("utils/ExtensionUtils"),EditorManager=require("editor/EditorManager"),FileViewController=require("project/FileViewController"),DocumentManager=require("document/DocumentManager"),ExtensionInterface=require("utils/ExtensionInterface"),CommandManager=require("command/CommandManager"),Commands=require("command/Commands"),Menus=require("command/Menus"),WorkspaceManager=require("view/WorkspaceManager"),AppInit=require("utils/AppInit"),ModalBar=require("widgets/ModalBar").ModalBar,PreferencesManager=require("preferences/PreferencesManager"),ProjectManager=require("project/ProjectManager"),MainViewManager=require("view/MainViewManager"),Strings=require("strings"),Mustache=require("thirdparty/mustache/mustache"),Metrics=require("utils/Metrics"),LiveDevelopment=require("LiveDevelopment/main"),LiveDevServerManager=require("LiveDevelopment/LiveDevServerManager"),NativeApp=require("utils/NativeApp"),StringUtils=require("utils/StringUtils"),FileSystem=require("filesystem/FileSystem"),BrowserStaticServer=require("./BrowserStaticServer"),NodeStaticServer=require("./NodeStaticServer"),LivePreviewSettings=require("./LivePreviewSettings"),NodeUtils=require("utils/NodeUtils"),TrustProjectHTML=require("text!./trust-project.html"),panelHTML=require("text!./panel.html"),Dialogs=require("widgets/Dialogs"),DefaultDialogs=require("widgets/DefaultDialogs"),utils=require("./utils"),StateManager=PreferencesManager.stateManager,STATE_CUSTOM_SERVER_BANNER_ACK="customServerBannerDone";let customServerModalBar;const isBrowser=!Phoenix.isNativeApp,StaticServer=Phoenix.isNativeApp?NodeStaticServer:BrowserStaticServer,EVENT_EMBEDDED_IFRAME_WHO_AM_I="whoAmIframePhoenix",EVENT_EMBEDDED_IFRAME_FOCUS_EDITOR="embeddedIframeFocusEditor",PREVIEW_TRUSTED_PROJECT_KEY="preview_trusted",PREVIEW_PROJECT_README_KEY="preview_readme",LIVE_PREVIEW_PANEL_ID="live-preview-panel",LIVE_PREVIEW_IFRAME_ID="panel-live-preview-frame",LIVE_PREVIEW_IFRAME_HTML='\n    <iframe id="panel-live-preview-frame" title="Live Preview" style="border: none"\n             width="100%" height="100%" seamless="true"\n             src=\'about:blank\'\n             sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-scripts allow-forms allow-modals allow-pointer-lock">\n    </iframe>\n    ';let $icon,$settingsIcon,$iframe,$panel,$pinUrlBtn,$highlightBtn,$livePreviewPopBtn,$reloadBtn,$chromeButton,$safariButton,$edgeButton,$firefoxButton,$chromeButtonBallast,$safariButtonBallast,$edgeButtonBallast,$firefoxButtonBallast,$panelTitle;Phoenix.isTestWindow&&(window._livePreviewIntegTest={urlLoadCount:0,STATE_CUSTOM_SERVER_BANNER_ACK:STATE_CUSTOM_SERVER_BANNER_ACK});let customLivePreviewBannerShown=!1;function _isLiveHighlightEnabled(){return CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).getChecked()}function _getTrustProjectPage(){const trustProjectMessage=StringUtils.format(Strings.TRUST_PROJECT,path.basename(ProjectManager.getProjectRoot().fullPath)),templateVars={trustProjectMessage:trustProjectMessage,Strings:Strings};return Mustache.render(TrustProjectHTML,templateVars)}function _isProjectPreviewTrusted(){if(Phoenix.isTestWindow||Phoenix.isNativeApp)return!0;const projectPath=ProjectManager.getProjectRoot().fullPath;if(projectPath===ProjectManager.getWelcomeProjectPath()||projectPath===ProjectManager.getExploreProjectPath())return!0;const isTrustedProject=`${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;return!!PhStore.getItem(isTrustedProject)}function _setProjectReadmePreviewdOnce(){const projectPath=ProjectManager.getProjectRoot().fullPath,previewReadmeKey=`${PREVIEW_PROJECT_README_KEY}-${projectPath}`;PhStore.setItem(previewReadmeKey,!0)}function _isProjectReadmePreviewdOnce(){const projectPath=ProjectManager.getProjectRoot().fullPath,previewReadmeKey=`${PREVIEW_PROJECT_README_KEY}-${projectPath}`;return!!PhStore.getItem(previewReadmeKey)}function _createStaticServer(){var config={pathResolver:ProjectManager.makeProjectRelativeIfPossible,root:ProjectManager.getProjectRoot().fullPath};return new StaticServer.StaticServer(config)}StaticServer.on("whoAmIframePhoenix",function(){if($iframe&&$iframe[0]){const iframeDom=$iframe[0];iframeDom.contentWindow.postMessage({type:"WHO_AM_I_RESPONSE",isTauri:Phoenix.isNativeApp},"*")}}),StaticServer.on("embeddedIframeFocusEditor",function(){const editor=EditorManager.getActiveEditor();editor.focus()}),window._trustCurrentProjectForLivePreview=function(){$iframe.attr("srcdoc",null);const projectPath=ProjectManager.getProjectRoot().fullPath,isTrustedProjectKey=`${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;PhStore.setItem(isTrustedProjectKey,!0),_loadPreview(!0)},ExtensionInterface.registerExtensionInterface(ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW,exports),ExtensionUtils.loadStyleSheet(module,"live-preview.css");let panel,urlPinned,currentLivePreviewURL="",currentPreviewFile="",panelShownAtStartup;function _blankIframe(){let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe}function _setPanelVisibility(isVisible){isVisible?(panelShownAtStartup=!0,$icon.toggleClass("active"),panel.show(),_loadPreview(!0,!0),_showCustomServerBannerIfNeeded()):($icon.toggleClass("active"),_blankIframe(),panel.hide())}function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon){let visible=panel&&panel.isVisible();visible&&(LiveDevelopment.isInactive()||explicitClickOnLPIcon)?LiveDevelopment.openLivePreview():visible||!LiveDevelopment.isActive()||StaticServer.hasActiveLivePreviews()||LiveDevelopment.closeLivePreview()}function _toggleVisibilityOnClick(){let visible;_setPanelVisibility(!panel.isVisible()),_startOrStopLivePreviewIfRequired(!0)}function _togglePinUrl(){let pinStatus=$pinUrlBtn.hasClass("pin-icon");pinStatus?$pinUrlBtn.removeClass("pin-icon").addClass("unpin-icon"):$pinUrlBtn.removeClass("unpin-icon").addClass("pin-icon"),urlPinned=!pinStatus,LiveDevelopment.setLivePreviewPinned(urlPinned,currentPreviewFile),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"pinURLBtn","click")}function _updateLiveHighlightToggleStatus(){let isHighlightEnabled;_isLiveHighlightEnabled()?$highlightBtn.removeClass("pointer-icon").addClass("pointer-fill-icon"):$highlightBtn.removeClass("pointer-fill-icon").addClass("pointer-icon")}function _toggleLiveHighlights(){LiveDevelopment.togglePreviewHighlight(),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"HighlightBtn","click")}const ALLOWED_BROWSERS_NAMES=["chrome","firefox","safari","edge","browser","browserPrivate"];function _popoutLivePreview(browserName){const openURL=StaticServer.getTabPopoutURL(currentLivePreviewURL);browserName&&ALLOWED_BROWSERS_NAMES.includes(browserName)?(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popout",browserName),NodeUtils.openUrlInBrowser(openURL,browserName).then(()=>{_loadPreview(!0),_setPanelVisibility(!1)}).catch(err=>{console.error("Error opening url in browser: ",browserName,err),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popFail",browserName),Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,StringUtils.format(Strings.LIVE_DEV_OPEN_ERROR_TITLE,browserName),StringUtils.format(Strings.LIVE_DEV_OPEN_ERROR_MESSAGE,browserName))})):(NativeApp.openURLInDefaultBrowser(openURL,"livePreview"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popoutBtn","click"),_loadPreview(!0),_setPanelVisibility(!1))}function _setTitle(fileName,fullPath,currentLivePreviewURL){let message=Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,tooltip=message;fileName&&(message=`${fileName} - ${Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC}`,tooltip=StringUtils.format(Strings.LIVE_DEV_TOOLTIP_SHOW_IN_EDITOR,fileName)),currentLivePreviewURL&&(tooltip=`${tooltip}\n${currentLivePreviewURL}`),$panelTitle.text(currentLivePreviewURL||message),$panelTitle.attr("title",tooltip),$panelTitle.attr("data-fullPath",fullPath)}function _showOpenBrowserIcons(){Phoenix.isNativeApp&&($chromeButton.removeClass("forced-hidden"),$chromeButtonBallast.removeClass("forced-hidden"),$chromeButtonBallast.addClass("forced-inVisible"),$edgeButton.removeClass("forced-hidden"),$edgeButtonBallast.removeClass("forced-hidden"),$edgeButtonBallast.addClass("forced-inVisible"),$firefoxButton.removeClass("forced-hidden"),$firefoxButtonBallast.removeClass("forced-hidden"),$firefoxButtonBallast.addClass("forced-inVisible"),"mac"===brackets.platform&&($safariButton.removeClass("forced-hidden"),$safariButtonBallast.removeClass("forced-hidden"),$safariButtonBallast.addClass("forced-inVisible")))}async function _createExtensionPanel(){let templateVars={Strings:Strings,livePreview:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,clickToReload:Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,toggleLiveHighlight:Strings.LIVE_DEV_TOGGLE_LIVE_HIGHLIGHT,livePreviewSettings:Strings.LIVE_DEV_SETTINGS,clickToPopout:Strings.LIVE_DEV_CLICK_POPOUT,openInChrome:Strings.LIVE_DEV_OPEN_CHROME,openInSafari:Strings.LIVE_DEV_OPEN_SAFARI,openInEdge:Strings.LIVE_DEV_OPEN_EDGE,openInFirefox:Strings.LIVE_DEV_OPEN_FIREFOX,clickToPinUnpin:Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN};const PANEL_MIN_SIZE=50,INITIAL_PANEL_SIZE=document.body.clientWidth/2.5;($icon=$("#toolbar-go-live")).click(_toggleVisibilityOnClick),$panel=$(Mustache.render(panelHTML,templateVars)),$iframe=$panel.find("#panel-live-preview-frame"),$pinUrlBtn=$panel.find("#pinURLButton"),$highlightBtn=$panel.find("#highlightLPButton"),$reloadBtn=$panel.find("#reloadLivePreviewButton"),$livePreviewPopBtn=$panel.find("#livePreviewPopoutButton"),$chromeButton=$panel.find("#chromeButton"),$safariButton=$panel.find("#safariButton"),$edgeButton=$panel.find("#edgeButton"),$firefoxButton=$panel.find("#firefoxButton"),$chromeButtonBallast=$panel.find("#chromeButtonBallast"),$safariButtonBallast=$panel.find("#safariButtonBallast"),$edgeButtonBallast=$panel.find("#edgeButtonBallast"),$firefoxButtonBallast=$panel.find("#firefoxButtonBallast"),$panelTitle=$panel.find("#panel-live-preview-title"),$settingsIcon=$panel.find("#livePreviewSettingsBtn"),$panel.find(".live-preview-settings-banner-btn").on("click",()=>{CommandManager.execute(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"settingsBtnBanner","click")}),$panel.find(".custom-server-banner-close-icon").on("click",()=>{$panel.find(".live-preview-custom-banner").addClass("forced-hidden")}),$iframe[0].onload=function(){$iframe.attr("srcdoc",null)},$panelTitle.on("click",()=>{const fullPath=$panelTitle.attr("data-fullPath"),openPanes=MainViewManager.findInAllWorkingSets(fullPath);let paneToUse=MainViewManager.ACTIVE_PANE;openPanes.length&&(paneToUse=openPanes[0].paneId),FileViewController.openFileAndAddToWorkingSet(fullPath,paneToUse)}),$chromeButton.on("click",()=>{_popoutLivePreview("chrome")}),$safariButton.on("click",()=>{_popoutLivePreview("safari")}),$edgeButton.on("click",()=>{_popoutLivePreview("edge")}),$firefoxButton.on("click",()=>{_popoutLivePreview("firefox")}),_showOpenBrowserIcons(),$settingsIcon.click(()=>{CommandManager.execute(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"settingsBtn","click")});const popoutSupported=Phoenix.isNativeApp||Phoenix.browser.desktop.isChromeBased||Phoenix.browser.desktop.isFirefox;popoutSupported||$livePreviewPopBtn.addClass("forced-hidden"),panel=WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID,$panel,50,$icon,INITIAL_PANEL_SIZE),WorkspaceManager.recomputeLayout(!1),_updateLiveHighlightToggleStatus(),$pinUrlBtn.click(_togglePinUrl),$highlightBtn.click(_toggleLiveHighlights),$livePreviewPopBtn.click(_popoutLivePreview),$reloadBtn.click(()=>{_loadPreview(!0,!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"reloadBtn","click")})}async function _loadPreview(force,isReload){const isPreviewLoadable=panel.isVisible()||StaticServer.hasActiveLivePreviews();if(!isPreviewLoadable)return;let previewDetails=await StaticServer.getPreviewDetails();if(urlPinned&&!force)return;let newSrc=encodeURI(previewDetails.URL);if($iframe.attr("src")===newSrc&&!force)return;urlPinned||(currentLivePreviewURL=newSrc,currentPreviewFile=previewDetails.fullPath);const existingPreviewFile=$iframe&&$iframe.attr("data-original-path"),existingPreviewURL=$iframe&&$iframe.attr("data-original-src");isReload&&previewDetails.isNoPreview&&existingPreviewURL&&existingPreviewFile&&ProjectManager.isWithinProject(existingPreviewFile)?(currentLivePreviewURL=existingPreviewURL,currentPreviewFile=existingPreviewFile):isReload&&LiveDevelopment.openLivePreview();let relativeOrFullPath=ProjectManager.makeProjectRelativeIfPossible(currentPreviewFile);if(_setTitle(relativeOrFullPath=Phoenix.app.getDisplayPath(relativeOrFullPath),currentPreviewFile,previewDetails.isCustomServer?currentLivePreviewURL:""),panel.isVisible()){!customLivePreviewBannerShown&&LivePreviewSettings.isUsingCustomServer()&&previewDetails.isCustomServer&&(customLivePreviewBannerShown=!0,$panel.find(".live-preview-custom-banner").removeClass("forced-hidden"),$panel.find(".live-preview-banner-message").text(StringUtils.format(Strings.LIVE_PREVIEW_CUSTOM_SERVER_BANNER,LivePreviewSettings.getCustomServeBaseURL())));let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe,_isProjectPreviewTrusted()?($iframe.attr("src",currentLivePreviewURL),$iframe.attr("data-original-src",currentLivePreviewURL),$iframe.attr("data-original-path",currentPreviewFile),Phoenix.isTestWindow&&(window._livePreviewIntegTest.currentLivePreviewURL=currentLivePreviewURL,window._livePreviewIntegTest.urlLoadCount++)):$iframe.attr("srcdoc",_getTrustProjectPage())}Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render",utils.getExtension(previewDetails.fullPath)),StaticServer.redirectAllTabs(currentLivePreviewURL,force),Phoenix.isTestWindow&&(window._livePreviewIntegTest.redirectURL=currentLivePreviewURL,window._livePreviewIntegTest.redirectURLforce=force)}async function _projectFileChanges(evt,changedFile){if(changedFile&&changedFile.isFile&&(utils.isPreviewableFile(changedFile.fullPath)||utils.isServerRenderedFile(changedFile.fullPath))){const previewDetails=await StaticServer.getPreviewDetails();let shouldReload=!1;previewDetails.isCustomServer&&!previewDetails.serverSupportsHotReload&&(shouldReload=!0),previewDetails.isCustomServer||LiveDevelopment.isActive()&&previewDetails.isHTMLFile||(shouldReload=!0),shouldReload&&_loadPreview(!0)}}function _openReadmeMDIfFirstTime(){if(!_isProjectReadmePreviewdOnce()&&!Phoenix.isTestWindow){const readmePath=`${ProjectManager.getProjectRoot().fullPath}README.md`,fileEntry=FileSystem.getFileForPath(readmePath);fileEntry.exists(function(err,exists){!err&&exists&&(_setPanelVisibility(!0),CommandManager.execute(Commands.CMD_ADD_TO_WORKINGSET_AND_OPEN,{fullPath:readmePath}),_setProjectReadmePreviewdOnce())})}}let startupFilesLoadHandled=!1;async function _projectOpened(){if(customLivePreviewBannerShown=!1,$panel.find(".live-preview-custom-banner").addClass("forced-hidden"),_openReadmeMDIfFirstTime(),_customServerMetrics(),LiveDevelopment.isActive()||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||LiveDevelopment.openLivePreview(),urlPinned&&_togglePinUrl(),$iframe.attr("src",StaticServer.getNoPreviewURL()),!panelShownAtStartup&&!isBrowser&&ProjectManager.isStartupFilesLoaded()){startupFilesLoadHandled=!0;const currentDocument=DocumentManager.getCurrentDocument(),currentFile=currentDocument?currentDocument.file:ProjectManager.getSelectedItem(),isPreviewable=!!currentFile&&utils.isPreviewableFile(currentFile.fullPath);isPreviewable&&_setPanelVisibility(!0)}panel.isVisible()&&_loadPreview(!0)}function _startupFilesLoaded(){if(!startupFilesLoadHandled&&!panelShownAtStartup&&!isBrowser&&ProjectManager.isStartupFilesLoaded()){const currentDocument=DocumentManager.getCurrentDocument(),currentFile=currentDocument?currentDocument.file:ProjectManager.getSelectedItem(),isPreviewable=!!currentFile&&utils.isPreviewableFile(currentFile.fullPath);isPreviewable&&(_setPanelVisibility(!0),_loadPreview(!0,!0))}}function _projectClosed(){urlPinned&&_togglePinUrl(),LiveDevelopment.closeLivePreview(),customServerModalBar&&(customServerModalBar.close(),customServerModalBar=null)}function _activeDocChanged(){LivePreviewSettings.isUsingCustomServer()||LiveDevelopment.isActive()||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||LiveDevelopment.openLivePreview()}async function _openLivePreviewURL(_event,previewDetails){if(LivePreviewSettings.isUsingCustomServer())return;_loadPreview(!0);const currentPreviewDetails=await StaticServer.getPreviewDetails();currentPreviewDetails.isHTMLFile&&currentPreviewDetails.fullPath!==previewDetails.fullPath&&console.error("Live preview URLs differ between phoenix live preview extension and core live preview",currentPreviewDetails,previewDetails)}async function _currentFileChanged(_event,changedFile){if(!changedFile||!changedFile.fullPath||!ProjectManager.isStartupFilesLoaded())return;const fullPath=changedFile.fullPath;changedFile&&_shouldShowCustomServerBar(fullPath)&&_showCustomServerBar();const shouldUseInbuiltPreview=utils.isMarkdownFile(fullPath)||utils.isSVG(fullPath);if(!urlPinned&&(!LivePreviewSettings.isUsingCustomServer()||LivePreviewSettings.getCustomServerConfig(fullPath)||shouldUseInbuiltPreview)&&changedFile&&(utils.isPreviewableFile(fullPath)||utils.isServerRenderedFile(fullPath))&&(_loadPreview(),!panelShownAtStartup&&ProjectManager.isStartupFilesLoaded())){let previewDetails=await StaticServer.getPreviewDetails();previewDetails&&!previewDetails.isNoPreview&&(_setPanelVisibility(!0),_loadPreview())}}function _showSettingsDialog(){return new Promise(resolve=>{LivePreviewSettings.showSettingsDialog().then(()=>{_loadPreview(),resolve()})})}function _customServerMetrics(){LivePreviewSettings.isUsingCustomServer()&&(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"customServ","yes"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"framework",LivePreviewSettings.getCustomServerFramework()||"unknown"),LivePreviewSettings.serverSupportsHotReload()&&Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"hotReload","yes"))}function _showCustomServerBannerIfNeeded(){const editor=EditorManager.getActiveEditor();editor&&_shouldShowCustomServerBar(editor.document.file.fullPath)&&_showCustomServerBar()}function _shouldShowCustomServerBar(fullPath){const isBannerAck=StateManager.get(STATE_CUSTOM_SERVER_BANNER_ACK,StateManager.PROJECT_CONTEXT);let panelVisible=panel&&panel.isVisible();return!(isBannerAck||LivePreviewSettings.isUsingCustomServer()||!panelVisible)&&utils.isServerRenderedFile(fullPath)}function _showCustomServerBar(){if(customServerModalBar)return;const searchBarHTML=`<div style="display: flex;justify-content: end;align-items: baseline;">\n            <div style="margin-right: 5px;">\n                ${Strings.LIVE_DEV_SETTINGS_BANNER}\n            </div>\n            <button class="btn btn-mini live-preview-settings" style="margin-right: 5px;">\n                ${Strings.LIVE_DEV_SETTINGS}\n            </button>\n            <div class="close-icon" style="align-self: center;margin-left: 10px;margin-right: 5px;cursor: pointer;"\n                title="${Strings.CLOSE}">\n                <i class="fa-solid fa-xmark"></i>\n            </div>\n        </div>`,$modal=(customServerModalBar=new ModalBar(searchBarHTML)).getRoot();$modal.find(".live-preview-settings").click(()=>{_showSettingsDialog().then(()=>{LivePreviewSettings.isUsingCustomServer()&&(customServerModalBar&&customServerModalBar.close(),customServerModalBar=null,StateManager.set(STATE_CUSTOM_SERVER_BANNER_ACK,!0,StateManager.PROJECT_CONTEXT))})}),$modal.find(".close-icon").click(()=>{customServerModalBar&&customServerModalBar.close(),customServerModalBar=null,StateManager.set(STATE_CUSTOM_SERVER_BANNER_ACK,!0,StateManager.PROJECT_CONTEXT)})}AppInit.appReady(function(){if(Phoenix.isSpecRunnerWindow)return;panelShownAtStartup=!LivePreviewSettings.shouldShowLivePreviewAtStartup(),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"atStart",LivePreviewSettings.shouldShowLivePreviewAtStartup()?"show":"hide"),_createExtensionPanel(),StaticServer.init(),LiveDevServerManager.registerServer({create:_createStaticServer},5),ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanges),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_projectOpened),ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE,_projectClosed),EditorManager.on("activeEditorChange",_activeDocChanged),ProjectManager.on(ProjectManager.EVENT_AFTER_STARTUP_FILES_LOADED,_startupFilesLoaded);let fileChangeListenerStartDelay=0;Phoenix.isNativeApp&&"mac"===Phoenix.platform&&(fileChangeListenerStartDelay=600),setTimeout(()=>{MainViewManager.on("currentFileChange",_currentFileChanged),Phoenix.isNativeApp&&"mac"===Phoenix.platform&&MainViewManager.getCurrentlyViewedFile()&&_currentFileChanged(null,MainViewManager.getCurrentlyViewedFile())},fileChangeListenerStartDelay),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,Commands.FILE_LIVE_FILE_PREVIEW,function(){_toggleVisibilityOnClick()}),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW_SETTINGS,Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS,_showSettingsDialog);let fileMenu=Menus.getMenu(Menus.AppMenuBar.FILE_MENU);function refreshPreview(){StaticServer.getPreviewDetails().then(previewDetails=>{if(_openReadmeMDIfFirstTime(),!LivePreviewSettings.shouldShowLivePreviewAtStartup())return;!previewDetails.URL||!isBrowser&&previewDetails.isNoPreview||panelShownAtStartup||_setPanelVisibility(!0);const shouldReload=!Phoenix.isNativeApp;_loadPreview(!0,shouldReload)})}fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW,"",Menus.AFTER,Commands.FILE_EXTENSION_MANAGER),fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS,"",Menus.AFTER,Commands.FILE_LIVE_FILE_PREVIEW),fileMenu.addMenuDivider(Menus.BEFORE,Commands.FILE_LIVE_FILE_PREVIEW),LiveDevelopment.openLivePreview(),LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL,_openLivePreviewURL),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_HIGHLIGHT_PREF_CHANGED,_updateLiveHighlightToggleStatus),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_PREVIEW_RELOAD,()=>{_loadPreview(!0)});let customServerRefreshedOnce=!1;function _handleNewCustomServer(){customLivePreviewBannerShown=!1,refreshPreview(),_customServerMetrics()}StaticServer.on(StaticServer.EVENT_SERVER_READY,function(_evt,event){LivePreviewSettings.isUsingCustomServer()&&customServerRefreshedOnce||(customServerRefreshedOnce=!0,refreshPreview())}),LivePreviewSettings.on(LivePreviewSettings.EVENT_SERVER_CHANGED,_handleNewCustomServer),LivePreviewSettings.on(LivePreviewSettings.EVENT_CUSTOM_SERVER_ENABLED_CHANGED,(_evt,enabled)=>{enabled?_handleNewCustomServer():$panel.find(".live-preview-custom-banner").addClass("forced-hidden")});let consecutiveEmptyClientsCount=0;setInterval(()=>{StaticServer.hasActiveLivePreviews()?consecutiveEmptyClientsCount=0:consecutiveEmptyClientsCount++,consecutiveEmptyClientsCount>5&&_startOrStopLivePreviewIfRequired()},1e3),_projectOpened()}),exports.LIVE_PREVIEW_PANEL_ID=LIVE_PREVIEW_PANEL_ID});
//# sourceMappingURL=main.js.map
