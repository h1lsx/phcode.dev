define(function(require,exports,module){const livePreviewSettings=require("text!./livePreviewSettings.html"),Dialogs=require("widgets/Dialogs"),ProjectManager=require("project/ProjectManager"),Strings=require("strings"),utils=require("./utils"),Metrics=require("utils/Metrics"),FileSystem=require("filesystem/FileSystem"),PreferencesManager=require("preferences/PreferencesManager"),EventDispatcher=require("utils/EventDispatcher"),Mustache=require("thirdparty/mustache/mustache");EventDispatcher.makeEventDispatcher(exports);const FRAMEWORK_CUSTOM="Custom",FRAMEWORK_DOCUSAURUS="Docusaurus",EVENT_SERVER_CHANGED="customServerChanged",SUPPORTED_FRAMEWORKS={};SUPPORTED_FRAMEWORKS[FRAMEWORK_DOCUSAURUS]={configFile:"docusaurus.config.js",hotReloadSupported:!0};const PREFERENCE_SHOW_LIVE_PREVIEW_PANEL="livePreviewShowAtStartup",PREFERENCE_PROJECT_SERVER_ENABLED="livePreviewUseDevServer",PREFERENCE_PROJECT_SERVER_URL="livePreviewServerURL",PREFERENCE_PROJECT_SERVER_PATH="livePreviewServerProjectPath",PREFERENCE_PROJECT_SERVER_HOT_RELOAD_SUPPORTED="livePreviewHotReloadSupported",PREFERENCE_PROJECT_PREVIEW_FRAMEWORK="livePreviewFramework";async function detectFramework($frameworkSelect,$hotReloadChk){for(let framework of Object.keys(SUPPORTED_FRAMEWORKS)){const configFile=SUPPORTED_FRAMEWORKS[framework].configFile,hotReloadSupported=SUPPORTED_FRAMEWORKS[framework].hotReloadSupported;let filePath=path.join(ProjectManager.getProjectRoot().fullPath,configFile);const exists=await FileSystem.existsAsync(filePath);if(exists)return $frameworkSelect.val(framework),void $hotReloadChk.prop("checked",hotReloadSupported)}$frameworkSelect.val(FRAMEWORK_CUSTOM),$hotReloadChk.prop("checked",!1)}function _saveProjectPreferences(useCustomServer,liveServerURL,serveRoot,hotReloadSupported,framework){PreferencesManager.set(PREFERENCE_PROJECT_SERVER_ENABLED,useCustomServer,PreferencesManager.PROJECT_SCOPE),PreferencesManager.get(PREFERENCE_PROJECT_SERVER_URL,PreferencesManager.PROJECT_SCOPE)!==liveServerURL&&PreferencesManager.set(PREFERENCE_PROJECT_SERVER_URL,liveServerURL,PreferencesManager.PROJECT_SCOPE),PreferencesManager.set(PREFERENCE_PROJECT_SERVER_PATH,serveRoot,PreferencesManager.PROJECT_SCOPE),PreferencesManager.set(PREFERENCE_PROJECT_SERVER_HOT_RELOAD_SUPPORTED,hotReloadSupported,PreferencesManager.PROJECT_SCOPE),PreferencesManager.set(PREFERENCE_PROJECT_PREVIEW_FRAMEWORK,framework,PreferencesManager.PROJECT_SCOPE)}function showSettingsDialog(){return new Promise(resolve=>{const currentSettings={},$template=$(Mustache.render(`${livePreviewSettings}`,{settings:currentSettings,Strings:Strings})),$livePreviewServerURL=$template.find("#livePreviewServerURL"),$enableCustomServerChk=$template.find("#enableCustomServerChk"),$showLivePreviewAtStartup=$template.find("#showLivePreviewAtStartupChk"),$serveRoot=$template.find("#serveRoot"),$serveRootLabel=$template.find("#serveRootLabel"),$hotReloadChk=$template.find("#hotReloadChk"),$hotReloadLabel=$template.find("#hotReloadLabel"),$frameworkLabel=$template.find("#frameworkLabel"),$frameworkSelect=$template.find("#frameworkSelect");function refreshValues(){$enableCustomServerChk.is(":checked")?$livePreviewServerURL.prop("disabled",!1):$livePreviewServerURL.prop("disabled",!0),$enableCustomServerChk.is(":checked")&&$livePreviewServerURL.val()?($serveRoot.removeClass("forced-hidden"),$serveRootLabel.removeClass("forced-hidden"),$hotReloadChk.removeClass("forced-hidden"),$hotReloadLabel.removeClass("forced-hidden"),$frameworkSelect.removeClass("forced-hidden"),$frameworkLabel.removeClass("forced-hidden")):($serveRoot.addClass("forced-hidden"),$serveRootLabel.addClass("forced-hidden"),$hotReloadChk.addClass("forced-hidden"),$hotReloadLabel.addClass("forced-hidden"),$frameworkSelect.addClass("forced-hidden"),$frameworkLabel.addClass("forced-hidden"))}$enableCustomServerChk.prop("checked",PreferencesManager.get(PREFERENCE_PROJECT_SERVER_ENABLED)),$showLivePreviewAtStartup.prop("checked",PreferencesManager.get(PREFERENCE_SHOW_LIVE_PREVIEW_PANEL)),$hotReloadChk.prop("checked",!!PreferencesManager.get(PREFERENCE_PROJECT_SERVER_HOT_RELOAD_SUPPORTED)),null===PreferencesManager.get(PREFERENCE_PROJECT_PREVIEW_FRAMEWORK)?detectFramework($frameworkSelect,$hotReloadChk):$frameworkSelect.val(PreferencesManager.get(PREFERENCE_PROJECT_PREVIEW_FRAMEWORK)),$livePreviewServerURL.on("input",refreshValues),$enableCustomServerChk.on("change",refreshValues),$livePreviewServerURL.val(PreferencesManager.get(PREFERENCE_PROJECT_SERVER_URL)),$serveRoot.val(PreferencesManager.get(PREFERENCE_PROJECT_SERVER_PATH)),refreshValues(),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"settings","dialog"),Dialogs.showModalDialogUsingTemplate($template).done(function(id){id===Dialogs.DIALOG_BTN_OK&&(PreferencesManager.set(PREFERENCE_SHOW_LIVE_PREVIEW_PANEL,$showLivePreviewAtStartup.is(":checked")),_saveProjectPreferences($enableCustomServerChk.is(":checked"),$livePreviewServerURL.val(),$serveRoot.val(),$hotReloadChk.is(":checked"),$frameworkSelect.val())),resolve()})})}function shouldShowLivePreviewAtStartup(){return PreferencesManager.get(PREFERENCE_SHOW_LIVE_PREVIEW_PANEL)}function _resolveServer(){if(!PreferencesManager.get(PREFERENCE_PROJECT_SERVER_ENABLED)||!PreferencesManager.get(PREFERENCE_PROJECT_SERVER_URL))return null;let url=PreferencesManager.get(PREFERENCE_PROJECT_SERVER_URL);url.endsWith("/")||(url=`${url}/`);let path=PreferencesManager.get(PREFERENCE_PROJECT_SERVER_PATH)||"/";return path||(path="/"),path.endsWith("/")||(path=`${path}/`),path.startsWith("/")&&(path=path.substring(1)),{serverURL:url,pathInProject:path}}function getCustomServeRoot(){return PreferencesManager.get(PREFERENCE_PROJECT_SERVER_PATH)||"/"}function getCustomServeBaseURL(){return PreferencesManager.get(PREFERENCE_PROJECT_SERVER_URL)||""}function getCustomServerConfig(fullPath){const customServer=_resolveServer();if(!customServer||!ProjectManager.isWithinProject(fullPath))return null;const projectRoot=ProjectManager.getProjectRoot().fullPath,relativePath=path.relative(projectRoot,fullPath),framework=PreferencesManager.get(PREFERENCE_PROJECT_PREVIEW_FRAMEWORK);let pathRelativeToServeRoot=relativePath;""!==customServer.pathInProject&&relativePath.startsWith(customServer.pathInProject)&&(pathRelativeToServeRoot=relativePath.replace(customServer.pathInProject,""));const isServerRenderedURL=(utils.isPreviewableFile(fullPath)||utils.isServerRenderedFile(fullPath))&&!utils.isMarkdownFile(fullPath)&&!utils.isSVG(fullPath);if(framework===FRAMEWORK_DOCUSAURUS&&utils.isMarkdownFile(fullPath))pathRelativeToServeRoot="";else if(!isServerRenderedURL||""!==customServer.pathInProject&&!relativePath.startsWith(customServer.pathInProject))return null;return`${customServer.serverURL}${pathRelativeToServeRoot}`}function getCustomServerFramework(){return PreferencesManager.get(PREFERENCE_PROJECT_PREVIEW_FRAMEWORK)}function isUsingCustomServer(){return!!_resolveServer()}function serverSupportsHotReload(){const customServer=_resolveServer();return customServer&&!!PreferencesManager.get(PREFERENCE_PROJECT_SERVER_HOT_RELOAD_SUPPORTED)}function _serverChanged(){exports.trigger(EVENT_SERVER_CHANGED)}PreferencesManager.definePreference(PREFERENCE_PROJECT_SERVER_ENABLED,"boolean",!1,{description:Strings.LIVE_DEV_SETTINGS_SERVER_PREFERENCE}),PreferencesManager.definePreference(PREFERENCE_SHOW_LIVE_PREVIEW_PANEL,"boolean",!0,{description:Strings.LIVE_DEV_SETTINGS_STARTUP_PREFERENCE}),PreferencesManager.definePreference(PREFERENCE_PROJECT_SERVER_HOT_RELOAD_SUPPORTED,"boolean",null,{description:Strings.LIVE_DEV_SETTINGS_HOT_RELOAD_PREFERENCE}),PreferencesManager.definePreference(PREFERENCE_PROJECT_SERVER_URL,"string","",{description:Strings.LIVE_DEV_SETTINGS_SERVE_PREFERENCE}),PreferencesManager.definePreference(PREFERENCE_PROJECT_SERVER_PATH,"string","/",{description:Strings.LIVE_DEV_SETTINGS_SERVER_ROOT_PREF}),PreferencesManager.definePreference(PREFERENCE_PROJECT_PREVIEW_FRAMEWORK,"string",null,{description:Strings.LIVE_DEV_SETTINGS_FRAMEWORK_PREFERENCES,values:Object.keys(SUPPORTED_FRAMEWORKS)}),PreferencesManager.on("change",PREFERENCE_PROJECT_SERVER_URL,_serverChanged),exports.showSettingsDialog=showSettingsDialog,exports.getCustomServerConfig=getCustomServerConfig,exports.getCustomServeBaseURL=getCustomServeBaseURL,exports.getCustomServeRoot=getCustomServeRoot,exports.isUsingCustomServer=isUsingCustomServer,exports.getCustomServerFramework=getCustomServerFramework,exports.serverSupportsHotReload=serverSupportsHotReload,exports.shouldShowLivePreviewAtStartup=shouldShowLivePreviewAtStartup,exports.EVENT_SERVER_CHANGED=EVENT_SERVER_CHANGED});
//# sourceMappingURL=LivePreviewSettings.js.map
